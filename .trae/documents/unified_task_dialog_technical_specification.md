# Техническая спецификация: Унифицированный диалог создания задач

## 1. Анализ текущих компонентов создания задач

### 1.1 Существующие компоненты

#### CreateTaskDialog.tsx
- **Назначение**: Создание основных задач
- **Поля**: title, description, priority
- **Особенности**: 
  - Упрощенный интерфейс
  - Базовая валидация через Zod
  - Использует `useCreateTaskMutation`
  - Поддержка teamId

#### CreateSubtaskDialog.tsx
- **Назначение**: Создание подзадач
- **Поля**: title, description, priority, assigneeId, dueDate
- **Особенности**:
  - Расширенный функционал (автосохранение, черновики)
  - Выбор исполнителя из команды
  - Календарь для выбора срока
  - Опция создания нескольких подзадач подряд
  - Использует `useCreateSubtaskMutation`
  - Поддержка parentTaskId

#### TasksPage быстрое создание
- **Назначение**: Быстрое создание через кнопку "Создать задачу"
- **Особенности**:
  - Открывает CreateTaskDialog
  - Передает контекст (teamId, projectId, userId)
  - Обработчик `handleCreateTask`

#### TaskHierarchy быстрое создание
- **Назначение**: Создание подзадач в контексте иерархии
- **Особенности**:
  - Открывает CreateSubtaskDialog
  - Передает parentTaskId
  - Интеграция с обновлением иерархии

### 1.2 Проблемы текущей архитектуры

1. **Дублирование кода**: Общие поля и логика повторяются
2. **Несогласованность UI**: Разные стили и подходы к интерфейсу
3. **Разные API**: `useCreateTaskMutation` vs `useCreateSubtaskMutation`
4. **Сложность поддержки**: Изменения нужно вносить в несколько мест
5. **Избыточные функции**: Автосохранение и черновики только в подзадачах

## 2. Архитектура нового унифицированного диалога

### 2.1 Компонент UnifiedTaskDialog

```typescript
interface UnifiedTaskDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  mode: 'task' | 'subtask';
  parentTaskId?: string;
  teamId?: string;
  projectId?: string;
  initialData?: Partial<TaskFormData>;
  onSuccess?: (task: Task) => void;
}

interface TaskFormData {
  title: string;
  description?: string;
  priority: TaskPriority;
  assigneeId?: string;
  dueDate?: Date;
  estimatedHours?: number;
  tags?: string[];
}
```

### 2.2 Архитектурные принципы

1. **Единый интерфейс**: Один компонент для всех типов создания задач
2. **Режимы работы**: Переключение между созданием задач и подзадач
3. **Прогрессивное раскрытие**: Показ дополнительных полей по необходимости
4. **Консистентный UI**: Единый стиль и поведение
5. **Гибкая конфигурация**: Настройка через пропсы

### 2.3 Структура компонента

```
UnifiedTaskDialog/
├── index.tsx                 # Основной компонент
├── hooks/
│   ├── useTaskForm.ts       # Логика формы
│   ├── useTaskMutation.ts   # Унифицированные мутации
│   └── useTaskValidation.ts # Валидация
├── components/
│   ├── TaskFormFields.tsx   # Поля формы
│   ├── AssigneeSelect.tsx   # Выбор исполнителя
│   ├── DatePicker.tsx       # Выбор даты
│   └── PrioritySelect.tsx   # Выбор приоритета
└── types.ts                 # Типы
```

### 2.4 Логика переключения режимов

```typescript
const getFormConfig = (mode: 'task' | 'subtask') => {
  const baseFields = ['title', 'description', 'priority'];
  
  if (mode === 'subtask') {
    return {
      fields: [...baseFields, 'assigneeId', 'dueDate'],
      title: 'Создать подзадачу',
      mutation: 'createSubtask'
    };
  }
  
  return {
    fields: baseFields,
    title: 'Создать задачу', 
    mutation: 'createTask'
  };
};
```

## 3. План миграции существующих компонентов

### 3.1 Этап 1: Создание базового UnifiedTaskDialog

**Задачи:**
1. Создать новый компонент UnifiedTaskDialog
2. Реализовать базовые поля (title, description, priority)
3. Добавить переключение режимов task/subtask
4. Создать хуки для управления формой

**Критерии готовности:**
- Компонент создает задачи и подзадачи
- Валидация работает корректно
- UI консистентен с дизайн-системой

### 3.2 Этап 2: Добавление расширенных полей

**Задачи:**
1. Добавить поля assigneeId, dueDate для подзадач
2. Реализовать компоненты AssigneeSelect и DatePicker
3. Добавить условное отображение полей
4. Интегрировать с API команд

**Критерии готовности:**
- Все поля работают корректно
- Выбор исполнителя из команды
- Календарь для выбора даты

### 3.3 Этап 3: Замена существующих компонентов

**Задачи:**
1. Заменить CreateTaskDialog на UnifiedTaskDialog в TasksPage
2. Заменить CreateSubtaskDialog на UnifiedTaskDialog в TaskHierarchy
3. Обновить все места использования
4. Удалить старые компоненты

**Критерии готовности:**
- Все функции работают как раньше
- Нет регрессий в функциональности
- Код очищен от старых компонентов

### 3.4 Этап 4: Оптимизация и улучшения

**Задачи:**
1. Добавить дополнительные поля (estimatedHours, tags)
2. Реализовать улучшенную валидацию
3. Добавить автосохранение (опционально)
4. Оптимизировать производительность

## 4. API изменения

### 4.1 Унифицированный хук мутации

```typescript
export const useUnifiedTaskMutation = () => {
  const createTaskMutation = useCreateTaskMutation();
  const createSubtaskMutation = useCreateSubtaskMutation();
  
  return {
    createTask: createTaskMutation.mutateAsync,
    createSubtask: createSubtaskMutation.mutateAsync,
    isPending: createTaskMutation.isPending || createSubtaskMutation.isPending
  };
};
```

### 4.2 Унифицированная валидация

```typescript
const createUnifiedTaskSchema = (mode: 'task' | 'subtask') => {
  const baseSchema = {
    title: z.string().min(1, 'Название обязательно').max(200),
    description: z.string().max(1000).optional(),
    priority: z.nativeEnum(TaskPriority),
  };
  
  if (mode === 'subtask') {
    return z.object({
      ...baseSchema,
      assigneeId: z.string().optional(),
      dueDate: z.date().optional(),
    });
  }
  
  return z.object(baseSchema);
};
```

### 4.3 Обратная совместимость

- Существующие API endpoints остаются без изменений
- Старые хуки помечаются как deprecated
- Постепенная миграция без breaking changes

## 5. Тестирование нового компонента

### 5.1 Unit тесты

```typescript
describe('UnifiedTaskDialog', () => {
  it('should create task in task mode', () => {
    // Тест создания задачи
  });
  
  it('should create subtask in subtask mode', () => {
    // Тест создания подзадачи
  });
  
  it('should validate form fields correctly', () => {
    // Тест валидации
  });
  
  it('should handle mode switching', () => {
    // Тест переключения режимов
  });
});
```

### 5.2 Integration тесты

1. **Тест создания задачи из TasksPage**
   - Открытие диалога
   - Заполнение формы
   - Создание задачи
   - Обновление списка

2. **Тест создания подзадачи из TaskHierarchy**
   - Открытие диалога в режиме подзадачи
   - Заполнение расширенных полей
   - Создание подзадачи
   - Обновление иерархии

3. **Тест валидации**
   - Проверка обязательных полей
   - Проверка ограничений длины
   - Проверка корректности дат

### 5.3 E2E тесты

1. **Полный цикл создания задачи**
2. **Полный цикл создания подзадачи**
3. **Тест переключения между режимами**
4. **Тест обработки ошибок**

### 5.4 Тестирование производительности

1. **Время загрузки компонента**
2. **Время отклика при вводе**
3. **Использование памяти**
4. **Размер бандла**

## 6. Преимущества нового подхода

### 6.1 Для разработчиков

- **Единая кодовая база**: Легче поддерживать и развивать
- **Консистентность**: Единый подход к созданию задач
- **Переиспользование**: Общие компоненты и логика
- **Тестируемость**: Проще писать и поддерживать тесты

### 6.2 Для пользователей

- **Единообразие**: Одинаковый интерфейс везде
- **Предсказуемость**: Привычное поведение
- **Производительность**: Оптимизированная загрузка
- **Доступность**: Улучшенная поддержка a11y

### 6.3 Для бизнеса

- **Скорость разработки**: Быстрее добавлять новые функции
- **Качество**: Меньше багов благодаря единой логике
- **Масштабируемость**: Легче расширять функциональность
- **Поддержка**: Проще обучать новых разработчиков

## 7. Риски и митигация

### 7.1 Технические риски

**Риск**: Регрессии при миграции
**Митигация**: Поэтапная миграция с тщательным тестированием

**Риск**: Увеличение размера бандла
**Митигация**: Ленивая загрузка и code splitting

**Риск**: Сложность компонента
**Митигация**: Разбиение на подкомпоненты и хуки

### 7.2 UX риски

**Риск**: Изменение привычного интерфейса
**Митигация**: Сохранение знакомых паттернов взаимодействия

**Риск**: Производительность на слабых устройствах
**Митигация**: Оптимизация рендеринга и мемоизация

## 8. Временные рамки

- **Этап 1**: 1-2 недели
- **Этап 2**: 1 неделя  
- **Этап 3**: 1-2 недели
- **Этап 4**: 1 неделя
- **Тестирование**: Параллельно с разработкой

**Общее время**: 4-6 недель

## 9. Критерии успеха

1. **Функциональность**: Все существующие функции работают
2. **Производительность**: Нет деградации скорости
3. **Качество кода**: Покрытие тестами >90%
4. **UX**: Пользователи не замечают изменений
5. **Поддержка**: Время на исправление багов сокращено на 50%

Эта унификация станет основой для дальнейшего развития системы управления задачами и повысит качество разработки.