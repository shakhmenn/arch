# Аудит логики метрик

## Обзор
Проведен аудит системы метрик в приложении TFC (Team Formation Center). Выявлены критические проблемы архитектуры, дублирование кода и несогласованность API.

## 1. Критические проблемы

### 1.1 Дублирование entities
**Проблема**: Существуют две отдельные entities для метрик:
- `/src/entities/metric/` - старая система
- `/src/entities/metrics/` - новая система

**Детали**:
- Оба модуля экспортируют похожие типы и API функции
- Приложение использует только новую систему (`@entities/metrics`)
- Старая система остается неиспользуемой, но создает путаницу

**Влияние**:
- Увеличение размера бандла
- Путаница в разработке
- Потенциальные конфликты типов
- Сложность поддержки

### 1.2 Смешение старых и новых API endpoints
**Проблема**: Сервер поддерживает как новые, так и legacy endpoints:

**Новые endpoints**:
- `GET /metrics/definitions` - получить определения метрик
- `POST /metrics/values` - создать значение метрики
- `GET /metrics/values` - получить значения метрик
- `GET /metrics/dashboard` - получить дашборд

**Legacy endpoints**:
- `GET /metrics` - старый формат списка метрик
- `POST /metrics` - создание в старом формате
- `PATCH /metrics/:id` - обновление в старом формате

**Проблемы**:
- Клиент использует только новые endpoints, но старые остаются в коде
- Сервер содержит сложную логику конвертации между форматами
- Увеличенная сложность тестирования

### 1.3 Несогласованность типов
**Проблема**: Различия в определении типов между модулями:

**В `/entities/metric/model/types.ts`**:
```typescript
// Legacy типы
export interface Metric {
  id: number;
  userId: number;
  metricName: string;
  metricType: string;
  plannedValue?: number;
  actualValue?: number;
  // ...
}

// Новые типы
export interface MetricValue {
  id: number;
  value?: number;
  targetValue?: number;
  periodType: MetricPeriodType;
  // ...
}
```

**В `/entities/metrics/model/types.ts`**:
```typescript
// Только новые типы
export interface MetricValue {
  id: number;
  value?: number;
  targetValue?: number;
  // Отсутствует поле history
}
```

**Различия**:
- В старом модуле есть поле `history?: MetricHistory[]` в MetricValue
- В новом модуле это поле отсутствует
- Разные подходы к nullable полям

### 1.4 Проблемы архитектуры базы данных
**Проблема**: Отсутствие старой таблицы `metrics`

**Детали**:
- Сервер поддерживает legacy endpoints для таблицы `metrics`
- В схеме Prisma есть только новые таблицы: `MetricDefinition`, `MetricValue`, `MetricHistory`
- Legacy методы создают записи в новых таблицах, но с потерей данных

**Пример проблемы**:
```typescript
// В legacy методе create()
metricDefinition = await this.prisma.metricDefinition.create({
  data: {
    name: createMetricDto.metricName,
    category: MetricCategory.OPERATIONAL, // Хардкод!
    unit: 'CURRENCY', // Хардкод!
  },
});
```

### 1.5 Неиспользуемый код
**Проблема**: Большое количество неиспользуемого кода

**Неиспользуемые файлы**:
- `/src/entities/metric/` - весь модуль
- Legacy endpoints в контроллере
- Legacy методы в сервисе

**Неиспользуемые типы**:
- `Metric`, `CreateMetricDto`, `UpdateMetricDto` из старого модуля
- `BusinessContext` дублируется в profile entity

## 2. Проблемы производительности

### 2.1 Избыточные запросы в дашборде
**Проблема**: Метод `getDashboardData()` выполняет множественные запросы:
```typescript
const [metricValues, businessContext, recentHistory] = await Promise.all([
  this.prisma.metricValue.findMany({ /* сложный запрос */ }),
  this.prisma.businessContext.findUnique({ /* запрос */ }),
  this.prisma.metricHistory.findMany({ /* запрос с join */ }),
]);
```

**Проблемы**:
- Загрузка до 50 записей метрик для каждого пользователя
- Отсутствие пагинации
- Сложная логика группировки на уровне приложения

### 2.2 Отсутствие кеширования
**Проблема**: Дашборд метрик загружается при каждом запросе без кеширования

## 3. Проблемы UX/UI

### 3.1 Несогласованность в компонентах
**Проблема**: Разные компоненты используют разные подходы к отображению метрик:
- `MetricsPage` - полный дашборд
- `MetricsOverview` - краткий обзор
- `EditMetricPage` - редактирование отдельной метрики

**Проблемы**:
- Дублирование логики отображения
- Разные стили для одинаковых элементов
- Отсутствие единого компонента для метрик

## 4. Рекомендации по исправлению

### 4.1 Немедленные действия (Критично)

1. **Удалить дублирующий модуль**
   - Удалить `/src/entities/metric/`
   - Оставить только `/src/entities/metrics/`
   - Проверить отсутствие импортов из старого модуля

2. **Очистить legacy код на сервере**
   - Удалить legacy endpoints из контроллера
   - Удалить legacy методы из сервиса
   - Удалить legacy DTO

3. **Исправить типы**
   - Добавить недостающие поля в типы
   - Обеспечить согласованность между клиентом и сервером

### 4.2 Краткосрочные улучшения (1-2 недели)

1. **Оптимизировать дашборд**
   - Добавить пагинацию для метрик
   - Реализовать кеширование на уровне сервера
   - Оптимизировать SQL запросы

2. **Унифицировать компоненты**
   - Создать единый компонент `MetricCard`
   - Вынести общую логику в хуки
   - Стандартизировать стили

3. **Добавить валидацию**
   - Валидация дат периодов
   - Валидация числовых значений
   - Проверка бизнес-правил

### 4.3 Долгосрочные улучшения (1-2 месяца)

1. **Реализовать продвинутую аналитику**
   - Тренды и прогнозы
   - Сравнение с предыдущими периодами
   - Автоматические инсайты

2. **Добавить экспорт данных**
   - Экспорт в Excel/CSV
   - Генерация отчетов
   - Интеграция с внешними системами

3. **Улучшить производительность**
   - Реализовать Redis кеширование
   - Добавить индексы в базу данных
   - Оптимизировать запросы

## 5. План миграции

### Этап 1: Очистка (1-2 дня)
- [ ] Удалить `/src/entities/metric/`
- [ ] Удалить legacy endpoints
- [ ] Обновить импорты
- [ ] Запустить тесты

### Этап 2: Исправление типов (1 день)
- [ ] Синхронизировать типы клиента и сервера
- [ ] Добавить недостающие поля
- [ ] Обновить DTO

### Этап 3: Оптимизация (3-5 дней)
- [ ] Добавить пагинацию
- [ ] Реализовать кеширование
- [ ] Оптимизировать запросы
- [ ] Добавить валидацию

### Этап 4: Тестирование (2-3 дня)
- [ ] Unit тесты для API
- [ ] Integration тесты
- [ ] E2E тесты для UI
- [ ] Нагрузочное тестирование

## 6. Риски и митигация

### Высокие риски
1. **Поломка существующего функционала**
   - Митигация: Поэтапная миграция с тестированием
   - Откат: Сохранить backup перед изменениями

2. **Потеря данных**
   - Митигация: Миграция только кода, не данных
   - Проверка: Сравнение данных до и после

### Средние риски
1. **Снижение производительности**
   - Митигация: Мониторинг метрик производительности
   - Решение: Оптимизация запросов

## Заключение

Система метрик требует серьезного рефакторинга для устранения технического долга и улучшения производительности. Рекомендуется начать с критических проблем и постепенно переходить к улучшениям.

**Приоритет**: Критический  
**Время на исправление**: 1-2 недели  
**Влияние на пользователей**: Минимальное при правильной миграции